<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LenhaPro v28.0 - Cloud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root { --primary: #1a252f; --accent: #e67e22; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; font-size: 0.82rem; color: #333; padding-bottom: 60px; }
        .navbar { background-color: var(--primary) !important; border-bottom: 3px solid var(--accent); }
        .card-stats { border-radius: 12px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.08); background: #fff; }
        .tab-content { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 500px; border: 1px solid #eee; }
        .metric-large-value { font-size: 2.2rem; font-weight: 900; line-height: 1; color: #111; }
        .metric-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #7f8c8d; }
        .status-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 700; cursor: pointer; }
        .bg-pendente { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .bg-concluido { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .lote-card { border-left: 5px solid var(--primary); margin-bottom: 15px; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #eee; }
        .movimento-item { font-size: 0.75rem; padding: 5px 0; border-bottom: 1px dashed #eee; display: flex; flex-direction: column; }
        .movimento-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .movimento-obs { font-size: 0.68rem; color: #666; font-style: italic; padding-left: 18px; line-height: 1.2; margin-top: 2px; }
        .text-money { font-family: 'Courier New', Courier, monospace; font-weight: bold; }
        .pendente-item { font-size: 0.7rem; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 1px 0; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-3 p-2 sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
        <div>
            <span class="navbar-brand fw-bold mb-0">ü™µ LenhaPro v28.0</span>
            <div id="sync-status" style="font-size: 0.6rem; color: #aaa;">Conetando...</div>
        </div>
        <button class="btn btn-warning btn-sm fw-bold shadow-sm" onclick="window.abrirModal('modalSaldoInicial')">üí∞ DEFINIR SALDO INICIAL</button>
    </div>
</nav>

<div class="container">
    <!-- DASHBOARD -->
    <div class="row g-2 mb-3">
        <div class="col-md-5">
            <div class="card card-stats p-3 h-100 shadow-sm border-2 border-warning" style="background:#fff3cd">
                <div class="metric-label text-dark text-center"><i class="bi bi-truck me-1"></i> TOTAL POR ENTREGAR</div>
                <div id="resumoPendentesGlobal" class="metric-large-value mt-1 mb-2 text-center">0.0 m¬≥</div>
                <div id="listaPendentesPorTipo" class="px-2"></div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="row g-2">
                <div class="col-6"><div class="card card-stats p-2 border-start border-danger border-4 h-100"><div class="metric-label text-danger">D√≠vida p/ Receber</div><div id="resumoDividaEntregue" class="fw-bold h5 mb-0 text-danger text-money">0.00‚Ç¨</div><small style="font-size:0.55rem">Entregue e n√£o pago</small></div></div>
                <div class="col-6"><div class="card card-stats p-2 border-start border-success border-4 h-100"><div class="metric-label text-success">Lucro Real</div><div id="resumoLucro" class="fw-bold h5 mb-0 text-success text-money">0.00‚Ç¨</div><small style="font-size:0.55rem">Encomendas - Gastos</small></div></div>
                <div class="col-12"><div class="card card-stats p-3 bg-primary text-white shadow"><div class="metric-label text-white-50">DINHEIRO TOTAL EM M√ÉO</div><div id="resumoCaixaTotal" class="fw-bold h4 mb-0 text-money">0.00‚Ç¨</div><small style="font-size:0.6rem">Saldo Inicial + Recebido - Gasto</small></div></div>
            </div>
        </div>
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs mb-2" id="mainTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabEnc">üõí Encomendas</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabVen">‚úÖ Vendas</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLotes">üì¶ Lotes</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCli">üë• Clientes</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFin">üìä Finan√ßas</button></li>
    </ul>

    <div class="tab-content shadow-sm mb-5">
        <div id="tabEnc" class="tab-pane fade show active">
            <div class="d-flex gap-2 mb-3"><input type="text" id="filtroEnc" class="form-control form-control-sm" placeholder="üîç Filtrar encomendas..." onkeyup="window.render()"><button class="btn btn-primary btn-sm px-4 fw-bold" onclick="window.abrirModalEncomenda()">+ NOVA</button></div>
            <div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead class="table-light"><tr><th>Cliente</th><th>Tipo</th><th>m¬≥</th><th>Total ‚Ç¨</th><th>Entregue</th><th>Pago ‚Ç¨</th><th>Obs</th><th>A√ß√µes</th></tr></thead><tbody id="corpoEncomendas"></tbody></table></div>
        </div>
        <div id="tabVen" class="tab-pane fade">
            <input type="text" id="filtroVen" class="form-control form-control-sm mb-3" placeholder="üîç Pesquisar vendas..." onkeyup="window.render()">
            <div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead class="table-light"><tr><th>Cliente</th><th>Tipo</th><th>m¬≥</th><th>Total ‚Ç¨</th><th>Pago ‚Ç¨</th><th>Obs</th><th>Data</th><th>A√ß√µes</th></tr></thead><tbody id="corpoVendas"></tbody></table></div>
        </div>
        <div id="tabLotes" class="tab-pane fade"><button class="btn btn-dark btn-sm w-100 mb-3 fw-bold" onclick="window.abrirModalNovoLote()">+ COMPRAR CARGA</button><div id="listaLotes"></div></div>
        <div id="tabCli" class="tab-pane fade">
            <div class="d-flex gap-2 mb-3"><input type="text" id="filtroCli" class="form-control form-control-sm" placeholder="üîç Filtrar clientes..." onkeyup="window.render()"><button class="btn btn-success btn-sm px-4 fw-bold" onclick="window.abrirModalNovoCliente()">+ NOVO</button></div>
            <table class="table table-sm"><thead><tr><th>Nome</th><th>Info</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="listaClientesTabela"></tbody></table>
        </div>
        <div id="tabFin" class="tab-pane fade">
            <div class="card p-3 border-0 bg-light mb-4 shadow-sm border-start border-primary border-4">
                <h6 class="fw-bold mb-3">üìÅ Exportar Mensal para Excel</h6>
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="small fw-bold">M√™s para o Relat√≥rio:</label>
                        <input type="month" id="filtroMesExport" class="form-control form-control-sm">
                    </div>
                    <div class="col-6 col-md-4">
                        <button class="btn btn-success btn-sm w-100 fw-bold shadow-sm" onclick="window.exportarVendas()">üì• RECEITAS (ENC.)</button>
                    </div>
                    <div class="col-6 col-md-4">
                        <button class="btn btn-danger btn-sm w-100 fw-bold shadow-sm" onclick="window.exportarDespesas()">üì• GASTOS (TOTAL)</button>
                    </div>
                </div>
                <div class="mt-2 small text-muted">Vazio = Exporta tudo. Relat√≥rio de Receitas foca apenas em encomendas de clientes.</div>
            </div>
            <button class="btn btn-outline-danger btn-sm w-100 mb-3 fw-bold" onclick="window.abrirModalNovaDespesa()">+ REGISTAR GASTO GERAL</button>
            <table class="table table-sm table-hover"><thead class="table-light"><tr><th>Data</th><th>Descri√ß√£o / Notas</th><th>Valor</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="corpoDespesas"></tbody></table>
        </div>
    </div>
</div>

<!-- MODAIS -->
<div class="modal fade" id="modalSaldoInicial" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-3"><h6>Saldo Inicial</h6><input type="number" id="inputSaldoInicial" class="form-control mb-3" step="0.01"><button class="btn btn-warning w-100 fw-bold" onclick="window.confirmarSaldoInicial()">GRAVAR</button></div></div></div>
<div class="modal fade" id="modalCli" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-3"><h6 id="modalCliTitulo">Cliente</h6><input type="text" id="cliNome" class="form-control mb-2" placeholder="Nome"><input type="text" id="cliInfo" class="form-control mb-3" placeholder="Telem√≥vel / Morada"><button class="btn btn-success w-100 fw-bold" onclick="window.salvarCliente()">SALVAR</button></div></div></div>
<div class="modal fade" id="modalEnc" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-3"><h6 id="modalEncTitulo">Encomenda</h6><select id="encCliente" class="form-select mb-2"></select><select id="encTipoLenha" class="form-select mb-2"><option value="Mistura">Mistura</option><option value="Oliveira">Oliveira</option><option value="Carvalho">Carvalho</option><option value="OLI/CAR">OLI/CAR</option><option value="Eucalipto">Eucalipto</option><option value="Pinho">Pinho</option></select><div class="row g-2 mb-2"><div class="col-6"><label class="small">Metros:</label><input type="number" id="encMetros" class="form-control"></div><div class="col-6"><label class="small">Pre√ßo ‚Ç¨/m¬≥:</label><input type="number" id="encPreco" class="form-control" value="75"></div></div><input type="date" id="encDataC" class="form-control mb-2"><textarea id="encObs" class="form-control mb-3" placeholder="Observa√ß√µes..."></textarea><button class="btn btn-primary w-100 fw-bold" onclick="window.salvarEncomenda()">GUARDAR</button></div></div></div>
<div class="modal fade" id="modalLote" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-3"><h6 id="modalLoteTitulo">Lote</h6><input type="text" id="loteNome" class="form-control mb-2" placeholder="Nome da Carga"><input type="number" id="loteCusto" class="form-control mb-2" placeholder="Pre√ßo Total ‚Ç¨"><input type="date" id="loteData" class="form-control mb-3"><button class="btn btn-dark w-100 fw-bold" onclick="window.salvarLote()">GUARDAR</button></div></div></div>
<div class="modal fade" id="modalGastoLote" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-3"><h6 id="modalGastoLoteTitulo" class="text-danger">Gasto no Lote</h6><input type="text" id="gastoLoteDesc" class="form-control mb-2" placeholder="Descri√ß√£o"><input type="number" id="gastoLoteValor" class="form-control mb-2" placeholder="Valor ‚Ç¨"><textarea id="gastoLoteObs" class="form-control mb-3" placeholder="Notas extras..."></textarea><button class="btn btn-danger w-100 fw-bold" onclick="window.salvarGastoLote()">GUARDAR GASTO</button></div></div></div>
<div class="modal fade" id="modalSaidaLote" tabindex="-1"><div class="modal-dialog modal-dialog-centered text-center"><div class="modal-content p-3"><h6>Venda Direta (Lote)</h6><input type="number" id="saidaLoteM3" class="form-control mb-2" placeholder="m¬≥"><input type="number" id="saidaLoteValor" class="form-control mb-3" placeholder="‚Ç¨ Recebido"><button class="btn btn-primary w-100 fw-bold" onclick="window.salvarSaidaLote()">CONFIRMAR</button></div></div></div>
<div class="modal fade" id="modalDespesa" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-3"><h6 id="modalDespesaTitulo">Gasto Geral</h6><input type="text" id="despDesc" class="form-control mb-2" placeholder="Descri√ß√£o"><input type="number" id="despValor" class="form-control mb-2" placeholder="Valor ‚Ç¨"><input type="date" id="despData" class="form-control mb-2"><textarea id="despObs" class="form-control mb-3" placeholder="Notas..."></textarea><button class="btn btn-danger w-100 fw-bold" onclick="window.salvarDespesa()">GUARDAR</button></div></div></div>
<div class="modal fade" id="modalObs" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-3"><h6>üìù Editar Notas</h6><textarea id="editObsTexto" class="form-control mb-3" rows="4"></textarea><button class="btn btn-primary w-100 fw-bold" onclick="window.salvarObs()">GUARDAR</button></div></div></div>
<div class="modal fade" id="modalEntrega" tabindex="-1"><div class="modal-dialog modal-dialog-centered text-center"><div class="modal-content p-4"><h6>Entrega</h6><p>Falta: <b id="faltaM3Texto"></b> m¬≥</p><button class="btn btn-success mb-3 w-100 fw-bold" onclick="window.executarEntregaTotal()">ENTREGA TOTAL</button><div class="input-group"><input type="number" id="qtdParcialM3" class="form-control" placeholder="Parcial"><button class="btn btn-warning" onclick="window.executarEntregaParcial()">Ok</button></div></div></div></div>
<div class="modal fade" id="modalPagamento" tabindex="-1"><div class="modal-dialog modal-dialog-centered text-center"><div class="modal-content p-4"><h6>Pagamento</h6><p class="text-danger">D√≠vida: <b id="faltaDinheiroTexto"></b></p><button class="btn btn-success mb-3 w-100 fw-bold" onclick="window.executarPagamentoTotal()">PAGO TOTAL</button><div class="input-group"><input type="number" id="qtdParcialDinheiro" class="form-control" placeholder="Parcial"><button class="btn btn-warning" onclick="window.executarPagamentoParcial()">Ok</button></div></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDOsSDIznQ-dpYsLNrfM1JVyHyifJfYOtE", authDomain: "lenhapro1.firebaseapp.com", projectId: "lenhapro1", storageBucket: "lenhapro1.firebasestorage.app", messagingSenderId: "357732471130", appId: "1:357732471130:web:f4ce43cddb6a996981a363" };
    const app = initializeApp(firebaseConfig);
    const dbFirestore = getFirestore(app);
    const docRef = doc(dbFirestore, "producao", "dados_mestre");

    window.db = { clientes: [], encomendas: [], despesas: [], lotes: [], saldoInicial: 0 };
    let idAtivo = null, loteIdAtivo = null, movIdEdicao = null, encIdEdicao = null, loteIdEdicao = null, cliIdEdicao = null, despesaIdEdicao = null;

    const toN = (v) => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) { window.db = docSnap.data(); document.getElementById('sync-status').innerText = "üü¢ Nuvem Conetada"; }
        window.render();
    });

    window.atualizarBD = async function() { await setDoc(docRef, window.db); }
    window.abrirModal = (id) => new bootstrap.Modal(document.getElementById(id)).show();
    window.fecharModal = (id) => { const m = bootstrap.Modal.getInstance(document.getElementById(id)); if(m) m.hide(); window.atualizarBD(); }

    // SALDO / CLIENTES / ENCOMENDAS
    window.confirmarSaldoInicial = () => { window.db.saldoInicial = toN(document.getElementById('inputSaldoInicial').value); window.fecharModal('modalSaldoInicial'); };
    window.abrirModalNovoCliente = () => { cliIdEdicao = null; document.getElementById('modalCliTitulo').innerText = "Novo Cliente"; document.getElementById('cliNome').value = ""; document.getElementById('cliInfo').value = ""; window.abrirModal('modalCli'); };
    window.abrirEditarCliente = (id) => { cliIdEdicao = id; const c = window.db.clientes.find(x => x.id == id); document.getElementById('modalCliTitulo').innerText = "Editar Cliente"; document.getElementById('cliNome').value = c.nome; document.getElementById('cliInfo').value = c.info || ""; window.abrirModal('modalCli'); };
    window.salvarCliente = () => { const n = document.getElementById('cliNome').value; if(cliIdEdicao){ const i = window.db.clientes.findIndex(x=>x.id==cliIdEdicao); window.db.clientes[i].nome = n; window.db.clientes[i].info = document.getElementById('cliInfo').value; } else { window.db.clientes.push({id:Date.now().toString(), nome:n, info:document.getElementById('cliInfo').value}); } window.fecharModal('modalCli'); };
    window.abrirModalEncomenda = () => { encIdEdicao = null; document.getElementById('modalEncTitulo').innerText = "Nova Encomenda"; document.getElementById('encCliente').innerHTML = window.db.clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join(''); document.getElementById('encMetros').value = ""; document.getElementById('encPreco').value = 75; document.getElementById('encDataC').value = new Date().toISOString().split('T')[0]; document.getElementById('encObs').value = ""; window.abrirModal('modalEnc'); };
    window.abrirEditarEncomenda = (id) => { encIdEdicao = id; const e = window.db.encomendas.find(x => x.id == id); document.getElementById('modalEncTitulo').innerText = "Editar Encomenda"; document.getElementById('encCliente').innerHTML = window.db.clientes.map(c => `<option value="${c.id}" ${c.id==e.clienteId?'selected':''}>${c.nome}</option>`).join(''); document.getElementById('encTipoLenha').value = e.tipoLenha; document.getElementById('encMetros').value = e.metrosTotal; document.getElementById('encPreco').value = e.precoM3; document.getElementById('encDataC').value = e.dataEnc; document.getElementById('encObs').value = e.obs || ""; window.abrirModal('modalEnc'); };
    window.salvarEncomenda = () => { const m = toN(document.getElementById('encMetros').value), p = toN(document.getElementById('encPreco').value); const data = { clienteId: document.getElementById('encCliente').value, tipoLenha: document.getElementById('encTipoLenha').value, dataEnc: document.getElementById('encDataC').value, metrosTotal: m, precoM3: p, valorTotal: m * p, obs: document.getElementById('encObs').value }; if (encIdEdicao) { const idx = window.db.encomendas.findIndex(x => x.id == encIdEdicao); window.db.encomendas[idx] = { ...window.db.encomendas[idx], ...data }; } else { window.db.encomendas.push({ id: Date.now().toString(), metrosEntregues: 0, valorPago: 0, ...data }); } window.fecharModal('modalEnc'); };

    // LOTES / MOVIMENTOS
    window.abrirModalNovoLote = () => { loteIdEdicao = null; document.getElementById('loteNome').value = ""; document.getElementById('loteCusto').value = ""; document.getElementById('loteData').value = new Date().toISOString().split('T')[0]; window.abrirModal('modalLote'); };
    window.abrirEditarLote = (id) => { loteIdEdicao = id; const l = window.db.lotes.find(x => x.id == id); document.getElementById('loteNome').value = l.nome; document.getElementById('loteCusto').value = l.custoCompra; document.getElementById('loteData').value = l.data; window.abrirModal('modalLote'); };
    window.salvarLote = () => { const data = { nome: document.getElementById('loteNome').value, custoCompra: toN(document.getElementById('loteCusto').value), data: document.getElementById('loteData').value }; if (loteIdEdicao) { const idx = window.db.lotes.findIndex(x => x.id == loteIdEdicao); window.db.lotes[idx] = { ...window.db.lotes[idx], ...data }; } else { window.db.lotes.push({ id: Date.now().toString(), ...data, gastosExtras: [], saidasLenha: [] }); } window.fecharModal('modalLote'); };
    window.abrirGastoLote = (lId) => { loteIdAtivo = lId; movIdEdicao = null; document.getElementById('gastoLoteDesc').value = ""; document.getElementById('gastoLoteValor').value = ""; document.getElementById('gastoLoteObs').value = ""; window.abrirModal('modalGastoLote'); };
    window.abrirEditarGastoLote = (lId, mId) => { loteIdAtivo = lId; movIdEdicao = mId; const g = window.db.lotes.find(x => x.id == lId).gastosExtras.find(x => x.id == mId); document.getElementById('gastoLoteDesc').value = g.desc; document.getElementById('gastoLoteValor').value = g.valor; document.getElementById('gastoLoteObs').value = g.obs || ""; window.abrirModal('modalGastoLote'); };
    window.salvarGastoLote = () => { const l = window.db.lotes.find(x => x.id == loteIdAtivo); const d = { desc: document.getElementById('gastoLoteDesc').value, valor: toN(document.getElementById('gastoLoteValor').value), obs: document.getElementById('gastoLoteObs').value }; if(movIdEdicao) { const i = l.gastosExtras.findIndex(x=>x.id==movIdEdicao); l.gastosExtras[i] = { ...l.gastosExtras[i], ...d }; } else { l.gastosExtras.push({ id: Date.now(), ...d }); } window.fecharModal('modalGastoLote'); };
    window.abrirSaidaLote = (id) => { loteIdAtivo = id; window.abrirModal('modalSaidaLote'); };
    window.salvarSaidaLote = () => { window.db.lotes.find(l => l.id == loteIdAtivo).saidasLenha.push({ id: Date.now(), m3: toN(document.getElementById('saidaLoteM3').value), valor: toN(document.getElementById('saidaLoteValor').value) }); window.fecharModal('modalSaidaLote'); };

    // DESPESAS / OUTROS
    window.abrirModalNovaDespesa = () => { despesaIdEdicao = null; document.getElementById('despDesc').value = ""; document.getElementById('despValor').value = ""; document.getElementById('despData').value = new Date().toISOString().split('T')[0]; document.getElementById('despObs').value = ""; window.abrirModal('modalDespesa'); };
    window.abrirEditarDespesa = (id) => { despesaIdEdicao = id; const d = window.db.despesas.find(x => x.id == id); document.getElementById('despDesc').value = d.desc; document.getElementById('despValor').value = d.valor; document.getElementById('despData').value = d.data; document.getElementById('despObs').value = d.obs || ""; window.abrirModal('modalDespesa'); };
    window.salvarDespesa = () => { const d = { desc: document.getElementById('despDesc').value, valor: toN(document.getElementById('despValor').value), data: document.getElementById('despData').value, obs: document.getElementById('despObs').value }; if(despesaIdEdicao){ const i = window.db.despesas.findIndex(x=>x.id==despesaIdEdicao); window.db.despesas[i] = { ...window.db.despesas[i], ...d }; } else { window.db.despesas.push({id:Date.now().toString(), ...d}); } window.fecharModal('modalDespesa'); };
    window.abrirModalObs = (id) => { idAtivo = id; const e = window.db.encomendas.find(x => x.id == id); document.getElementById('editObsTexto').value = e.obs || ""; window.abrirModal('modalObs'); };
    window.salvarObs = () => { window.db.encomendas.find(x => x.id == idAtivo).obs = document.getElementById('editObsTexto').value; window.fecharModal('modalObs'); };
    window.abrirEntrega = (id) => { idAtivo = id; const e = window.db.encomendas.find(x => x.id == id); document.getElementById('faltaM3Texto').innerText = (toN(e.metrosTotal)-toN(e.metrosEntregues)).toFixed(1); window.abrirModal('modalEntrega'); };
    window.executarEntregaTotal = () => { window.db.encomendas.find(e => e.id == idAtivo).metrosEntregues = window.db.encomendas.find(e => e.id == idAtivo).metrosTotal; window.fecharModal('modalEntrega'); };
    window.executarEntregaParcial = () => { window.db.encomendas.find(e => e.id == idAtivo).metrosEntregues += toN(document.getElementById('qtdParcialM3').value); window.fecharModal('modalEntrega'); };
    window.abrirPagamento = (id) => { idAtivo = id; const e = window.db.encomendas.find(x => x.id == id); document.getElementById('faltaDinheiroTexto').innerText = (toN(e.valorTotal)-toN(e.valorPago)).toFixed(2)+"‚Ç¨"; window.abrirModal('modalPagamento'); };
    window.executarPagamentoTotal = () => { window.db.encomendas.find(e => e.id == idAtivo).valorPago = window.db.encomendas.find(e => e.id == idAtivo).valorTotal; window.fecharModal('modalPagamento'); };
    window.executarPagamentoParcial = () => { window.db.encomendas.find(e => e.id == idAtivo).valorPago += toN(document.getElementById('qtdParcialDinheiro').value); window.fecharModal('modalPagamento'); };
    window.apagar = (t, id) => { if(confirm("Eliminar registo?")) { window.db[t] = window.db[t].filter(x => x.id != id); window.atualizarBD(); } };
    window.apagarMovimento = (loteId, tipo, movId) => { if(confirm("Apagar movimento?")) { const l = window.db.lotes.find(x => x.id == loteId); l[tipo] = l[tipo].filter(m => m.id != movId); window.atualizarBD(); } };

    // RENDER PRINCIPAL
    window.render = function() {
        const fEnc = document.getElementById('filtroEnc').value.toLowerCase();
        const fVen = document.getElementById('filtroVen').value.toLowerCase();
        const fCli = document.getElementById('filtroCli').value.toLowerCase();
        let sRecEnc = 0, sRecLot = 0, sCusLotTot = 0, sGstGer = 0, dEntregueTot = 0, m3FaltaTot = 0;
        const pendentesPorTipo = { "Mistura": 0, "Oliveira": 0, "Carvalho": 0, "OLI/CAR": 0, "Eucalipto": 0, "Pinho": 0 };

        document.getElementById('listaLotes').innerHTML = (window.db.lotes || []).sort((a,b)=>new Date(b.data)-new Date(a.data)).map(l => {
            const m3V = (l.saidasLenha || []).reduce((a,c)=>a+toN(c.m3),0), rL = (l.saidasLenha || []).reduce((a,c)=>a+toN(c.valor),0), gE = (l.gastosExtras || []).reduce((a,c)=>a+toN(c.valor),0), cT = toN(l.custoCompra) + gE;
            sCusLotTot += cT; sRecLot += rL;
            let mHtml = "";
            (l.saidasLenha || []).forEach(m => { mHtml += `<div class="movimento-item"><div class="movimento-header"><span class="text-success fw-bold"><i class="bi bi-plus-circle-fill"></i> Sa√≠da: ${m.m3}m¬≥ (${toN(m.valor).toFixed(0)}‚Ç¨)</span><i class="bi bi-x text-muted" onclick="window.apagarMovimento('${l.id}','saidasLenha','${m.id}')"></i></div></div>`; });
            (l.gastosExtras || []).forEach(g => { mHtml += `<div class="movimento-item"><div class="movimento-header"><span class="text-danger fw-bold"><i class="bi bi-dash-circle-fill"></i> Gasto: ${g.desc} (${toN(g.valor).toFixed(0)}‚Ç¨)</span><div><i class="bi bi-pencil text-primary me-2" onclick="window.abrirEditarGastoLote('${l.id}','${g.id}')"></i><i class="bi bi-x text-muted" onclick="window.apagarMovimento('${l.id}','gastosExtras','${g.id}')"></i></div></div>${g.obs ? `<div class="movimento-obs">${g.obs}</div>` : ''}</div>`; });
            return `<div class="lote-card shadow-sm"><div class="row align-items-center"><div class="col-7"><span class="badge bg-dark mb-1">${l.data}</span><br><h6 class="mb-0 fw-bold">${l.nome}</h6><small class="text-muted">Custo: ${cT.toFixed(0)}‚Ç¨</small></div><div class="col-5 text-end"><button class="btn btn-sm btn-primary py-0" onclick="window.abrirSaidaLote('${l.id}')">+ Sa√≠da</button> <button class="btn btn-sm btn-danger py-0" onclick="window.abrirGastoLote('${l.id}')">+ Gasto</button></div></div><div class="bg-light p-2 rounded mt-2 mb-2" style="max-height: 150px; overflow-y: auto;">${mHtml || '<div class="text-center text-muted small py-2">Sem movimentos</div>'}</div><div class="d-flex justify-content-between align-items-center border-top pt-2"><div class="small"><b>Vendido:</b> ${m3V.toFixed(1)} m¬≥ | <b>Bal:</b> <span class="${(rL-cT)>=0?'text-success':'text-danger'} fw-bold">${(rL-cT).toFixed(1)}‚Ç¨</span></div><div><i class="bi bi-pencil-square text-primary me-2" onclick="window.abrirEditarLote('${l.id}')"></i><i class="bi bi-trash text-danger" onclick="window.apagar('lotes','${l.id}')"></i></div></div></div>`;
        }).join('');

        let htmlEnc = "", htmlVen = "";
        (window.db.encomendas || []).forEach(e => {
            const cli = window.db.clientes.find(c => c.id == e.clienteId); if(!cli) return;
            const vP = toN(e.valorPago), vT = toN(e.valorTotal), mTot = toN(e.metrosTotal), mEnt = toN(e.metrosEntregues);
            const isCon = (mEnt >= mTot && vP >= vT), temO = e.obs && e.obs.trim().length > 0;
            sRecEnc += vP;
            if(!isCon) {
                const fE = mTot - mEnt, dE = (mEnt * toN(e.precoM3)) - vP; if(dE > 0) dEntregueTot += dE; if(fE > 0) { m3FaltaTot += fE; if(pendentesPorTipo[e.tipoLenha] !== undefined) pendentesPorTipo[e.tipoLenha] += fE; }
                if(cli.nome.toLowerCase().includes(fEnc)) htmlEnc += `<tr><td><b>${cli.nome}</b></td><td><small>${e.tipoLenha}</small></td><td>${e.metrosTotal}</td><td>${vT.toFixed(0)}‚Ç¨</td><td><span onclick="window.abrirEntrega('${e.id}')" class="status-badge ${fE<=0?'bg-concluido':'bg-pendente'}">${e.metrosEntregues}m¬≥</span></td><td onclick="window.abrirPagamento('${e.id}')" class="${vP>=vT?'text-success':'text-danger fw-bold'}">${vP.toFixed(0)}‚Ç¨</td><td><button class="btn-obs" onclick="window.abrirModalObs('${e.id}')"><i class="bi ${temO ? 'bi-chat-left-dots-fill text-primary' : 'bi-chat-left-text text-muted'}"></i></button></td><td class="text-end"><i class="bi bi-pencil-square text-primary me-2" onclick="window.abrirEditarEncomenda('${e.id}')"></i><i class="bi bi-trash text-danger" onclick="window.apagar('encomendas','${e.id}')"></i></td></tr>`;
            } else {
                if(cli.nome.toLowerCase().includes(fVen)) htmlVen += `<tr class="table-success"><td><b>${cli.nome}</b></td><td><small>${e.tipoLenha}</small></td><td>${e.metrosTotal}</td><td>${vT.toFixed(0)}‚Ç¨</td><td>${vP.toFixed(0)}‚Ç¨</td><td><button class="btn-obs" onclick="window.abrirModalObs('${e.id}')"><i class="bi ${temO ? 'bi-chat-left-dots-fill text-primary' : 'bi-chat-left-text text-muted'}"></i></button></td><td><small>${e.dataEnc}</small></td><td class="text-end"><i class="bi bi-trash text-danger" onclick="window.apagar('encomendas','${e.id}')"></i></td></tr>`;
            }
        });
        document.getElementById('corpoEncomendas').innerHTML = htmlEnc;
        document.getElementById('corpoVendas').innerHTML = htmlVen;

        let pHtml = ""; for (const t in pendentesPorTipo) if(pendentesPorTipo[t] > 0) pHtml += `<div class="pendente-item"><span>${t}:</span> <b>${pendentesPorTipo[t].toFixed(1)} m¬≥</b></div>`;
        document.getElementById('listaPendentesPorTipo').innerHTML = pHtml || '<div class="text-center text-muted small">Tudo em dia!</div>';
        document.getElementById('listaClientesTabela').innerHTML = (window.db.clientes || []).filter(c=>c.nome.toLowerCase().includes(fCli)).map(c => `<tr><td><b>${c.nome}</b></td><td>${c.info||''}</td><td class="text-end"><i class="bi bi-pencil-square text-primary me-2" onclick="window.abrirEditarCliente('${c.id}')"></i><i class="bi bi-trash text-danger" onclick="window.apagar('clientes','${c.id}')"></i></td></tr>`).join('');
        
        sGstGer = (window.db.despesas || []).reduce((a,c) => a + toN(c.valor), 0);
        document.getElementById('corpoDespesas').innerHTML = (window.db.despesas || []).map(d => `<tr><td>${d.data}</td><td><b>${d.desc}</b><br><small class="text-muted italic">${d.obs || ''}</small></td><td>${toN(d.valor).toFixed(2)}‚Ç¨</td><td class="text-end"><i class="bi bi-pencil-square text-primary me-2" onclick="window.abrirEditarDespesa('${d.id}')"></i><i class="bi bi-trash text-danger" onclick="window.apagar('despesas', '${d.id}')"></i></td></tr>`).join('');

        const sI = toN(window.db.saldoInicial), tR = sRecEnc + sRecLot, tG = sCusLotTot + sGstGer, luc = tR - tG;
        document.getElementById('resumoLucro').innerText = luc.toFixed(2) + "‚Ç¨"; document.getElementById('resumoDividaEntregue').innerText = dEntregueTot.toFixed(2) + "‚Ç¨"; document.getElementById('resumoCaixaTotal').innerText = (sI + luc).toFixed(2) + "‚Ç¨"; document.getElementById('resumoPendentesGlobal').innerText = m3FaltaTot.toFixed(1) + " m¬≥"; document.getElementById('inputSaldoInicial').value = sI;
    };

    // EXPORTACOES REFORCADAS
    window.exportarVendas = () => {
        try {
            const mesAlvo = document.getElementById('filtroMesExport').value;
            let csv = "Data;Estado;Cliente;Tipo;m3 Totais;m3 Entregues;Valor Pago;Observacoes\n";
            
            (window.db.encomendas || []).forEach(e => {
                if (!mesAlvo || e.dataEnc.startsWith(mesAlvo)) {
                    const c = window.db.clientes.find(cli=>cli.id==e.clienteId);
                    const status = (toN(e.metrosEntregues) >= toN(e.metrosTotal) && toN(e.valorPago) >= toN(e.valorTotal)) ? "CONCLUIDO" : "PENDENTE";
                    const obs = (e.obs || "").replace(/;/g, ",").replace(/(\r\n|\n|\r)/gm, " ");
                    csv += `${e.dataEnc};${status};${c?c.nome:'?'};${e.tipoLenha};${e.metrosTotal};${e.metrosEntregues};${e.valorPago};${obs}\n`;
                }
            });

            window.baixarCSV(csv, `Receitas_Encomendas_${mesAlvo || 'Total'}.csv`);
        } catch(err) {
            alert("Erro ao exportar Receitas: " + err.message);
        }
    };

    window.exportarDespesas = () => {
        try {
            const mesAlvo = document.getElementById('filtroMesExport').value;
            let csv = "Data;Categoria;Descricao;Valor;Notas\n";
            
            (window.db.despesas || []).forEach(d => {
                if (!mesAlvo || d.data.startsWith(mesAlvo)) {
                    const obs = (d.obs || "").replace(/;/g, ",").replace(/(\r\n|\n|\r)/gm, " ");
                    csv += `${d.data};Geral;${d.desc};${d.valor};${obs}\n`;
                }
            });

            (window.db.lotes || []).forEach(l => {
                // Compra do Lote
                if (!mesAlvo || l.data.startsWith(mesAlvo)) {
                    csv += `${l.data};Compra Lote;${l.nome};${l.custoCompra};---\n`;
                }
                // Gastos Extras do Lote
                (l.gastosExtras || []).forEach(g => {
                    if (!mesAlvo || l.data.startsWith(mesAlvo)) { 
                        const obs = (g.obs || "").replace(/;/g, ",").replace(/(\r\n|\n|\r)/gm, " ");
                        csv += `${l.data};Gasto Lote;${g.desc} (Lote: ${l.nome});${g.valor};${obs}\n`;
                    }
                });
            });

            window.baixarCSV(csv, `Gastos_Total_${mesAlvo || 'Total'}.csv`);
        } catch(err) {
            alert("Erro ao exportar Gastos: " + err.message);
        }
    };

    window.baixarCSV = (csv, nome) => {
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = nome;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 0);
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
