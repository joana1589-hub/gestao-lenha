<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LenhaPro v45.0 - An√°lise Financeira Avan√ßada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1a252f; --accent: #e67e22; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; --info: #3498db; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; font-size: 0.82rem; color: #333; padding-bottom: 60px; }
        .navbar { background-color: var(--primary) !important; border-bottom: 3px solid var(--accent); }
        .card-stats { border-radius: 12px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.08); background: #fff; }
        .tab-content { background: white; padding: 15px; border-radius: 0 0 15px 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); min-height: 500px; border: 1px solid #eee; border-top: none; }
        .status-badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 700; cursor: pointer; display: inline-block; }
        .bg-pendente { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .lote-card { border-left: 5px solid var(--primary); margin-bottom: 15px; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #eee; }
        .movimento-item { font-size: 0.75rem; padding: 5px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; }
        .pendente-item { font-size: 0.75rem; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 4px 0; }
        .bg-data { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .obs-container { max-width: 150px; font-size: 0.72rem; line-height: 1.1; color: #666; word-wrap: break-word; white-space: normal; }
        .chart-container { position: relative; height: 180px; width: 100%; }
        .gst-item { font-size: 0.75rem; border-bottom: 1px solid #f0f0f0; padding: 5px 0; }
        .kpi-card { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
        .kpi-val { font-size: 1.1rem; font-weight: bold; display: block; }
        .kpi-lbl { font-size: 0.65rem; color: #777; text-transform: uppercase; font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-3 p-2 sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
        <div><span class="navbar-brand fw-bold mb-0">ü™µ LenhaPro v45.0</span></div>
        <button class="btn btn-warning btn-sm fw-bold shadow-sm" onclick="window.abrirModal('modalSaldoInicial')">üí∞ AJUSTAR CAIXA</button>
    </div>
</nav>

<div class="container">
    <!-- RESUMO GLOBAL (FIXO) -->
    <div class="row g-2 mb-3 text-center">
        <div class="col-md-4">
            <div class="card card-stats p-3 h-100 border-warning border-2" style="background:#fffcf0">
                <small class="text-muted fw-bold">PENDENTE ENTREGA</small>
                <div id="resumoPendentesGlobal" class="h2 fw-bold text-warning mb-0">0.0 m¬≥</div>
                <div id="listaPendentesPorTipo" class="text-start mt-2"></div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="row g-2">
                <div class="col-4"><div class="kpi-card border-start border-primary border-4"><span class="kpi-lbl">Dinheiro em M√£o</span><span id="resumoCaixaTotal" class="kpi-val text-primary">0‚Ç¨</span></div></div>
                <div class="col-4"><div class="kpi-card border-start border-danger border-4"><span class="kpi-lbl">D√≠vida Clientes</span><span id="resumoDividaEntregue" class="kpi-val text-danger">0‚Ç¨</span></div></div>
                <div class="col-4"><div class="kpi-card border-start border-success border-4"><span class="kpi-lbl">Lucro Acumulado</span><span id="resumoLucro" class="kpi-val text-success">0‚Ç¨</span></div></div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-0" id="mainTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabDash">üìà Dash Financeiro</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEnc">üõí Enc.</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabDiv">üö© D√≠vidas</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabVen">‚úÖ Vendas</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabLotes">üì¶ Lotes</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFin">üìä Finan√ßas</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCli">üë• Cli.</button></li>
    </ul>

    <div class="tab-content shadow-sm mb-5">
        <div id="tabDash" class="tab-pane fade show active">
            <!-- Filtros de Per√≠odo -->
            <div class="row g-2 mb-3 bg-light p-2 rounded">
                <div class="col-4"><label class="small fw-bold">Modo:</label><select id="dashModoFiltro" class="form-select form-select-sm" onchange="window.render()"><option value="mes">M√™s</option><option value="ano">Ano</option></select></div>
                <div class="col-4"><label class="small fw-bold">Ano:</label><select id="dashFiltroAno" class="form-select form-select-sm" onchange="window.render()"></select></div>
                <div id="colMesDash" class="col-4"><label class="small fw-bold">M√™s:</label><select id="dashFiltroMes" class="form-select form-select-sm" onchange="window.render()"><option value="01">Jan</option><option value="02">Fev</option><option value="03">Mar</option><option value="04">Abr</option><option value="05">Mai</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Ago</option><option value="09">Set</option><option value="10">Out</option><option value="11">Nov</option><option value="12">Dez</option></select></div>
            </div>

            <!-- KPIs do Per√≠odo -->
            <div class="row g-2 mb-4 text-center">
                <div class="col-3"><div class="card p-2 bg-success text-white"><small class="fw-bold">RECEITA</small><b id="dashReceitaMes" class="h5 mb-0">0‚Ç¨</b></div></div>
                <div class="col-3"><div class="card p-2 bg-danger text-white"><small class="fw-bold">GASTOS</small><b id="dashGastoMes" class="h5 mb-0">0‚Ç¨</b></div></div>
                <div class="col-3"><div class="card p-2 bg-dark text-white"><small class="fw-bold">MARGEM</small><b id="dashMargemMes" class="h5 mb-0">0%</b></div></div>
                <div class="col-3"><div class="card p-2 bg-primary text-white"><small class="fw-bold">m¬≥ VENDIDO</small><b id="dashMetrosMes" class="h5 mb-0">0</b></div></div>
            </div>

            <div class="row g-3">
                <!-- Coluna Esquerda: Gr√°ficos -->
                <div class="col-md-6">
                    <h6 class="fw-bold text-muted small"><i class="bi bi-pie-chart-fill"></i> DISTRIBUI√á√ÉO DE GASTOS</h6>
                    <div class="chart-container mb-4"><canvas id="chartGastoDist"></canvas></div>
                    
                    <h6 class="fw-bold text-muted small"><i class="bi bi-truck"></i> m¬≥ POR TIPO DE LENHA</h6>
                    <div class="chart-container"><canvas id="chartTipos"></canvas></div>
                </div>

                <!-- Coluna Direita: An√°lise de Custos Agrupados -->
                <div class="col-md-6">
                    <h6 class="fw-bold text-muted small"><i class="bi bi-list-check"></i> AN√ÅLISE DE CUSTOS (AGRUPADOS)</h6>
                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0" style="font-size: 0.75rem;">
                                <thead class="table-dark">
                                    <tr><th>Descri√ß√£o</th><th class="text-end">Total (‚Ç¨)</th><th class="text-end">%</th></tr>
                                </thead>
                                <tbody id="tabelaCustosAgrupados"></tbody>
                                <tfoot class="table-light fw-bold">
                                    <tr><td>TOTAL DO PER√çODO</td><td id="totalCustosDash" class="text-end text-danger">0‚Ç¨</td><td class="text-end">100%</td></tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <h6 class="fw-bold text-muted small mt-4"><i class="bi bi-people-fill"></i> TOP CLIENTES (m¬≥)</h6>
                    <div class="chart-container"><canvas id="chartClientes"></canvas></div>
                </div>
            </div>
        </div>

        <!-- OUTRAS TABS (Mantidas da v44.0) -->
        <div id="tabEnc" class="tab-pane fade">
            <div class="d-flex gap-2 mb-3"><input type="text" id="filtroEnc" class="form-control form-control-sm" placeholder="üîç Pesquisar..." onkeyup="window.render()"><button class="btn btn-primary btn-sm px-4 fw-bold" onclick="window.abrirModalEncomenda()">+ NOVA</button></div>
            <div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead><tr><th>Data</th><th>Cliente</th><th>Tipo</th><th>m¬≥</th><th>Total ‚Ç¨</th><th>Entregue</th><th>Pago</th><th>Obs</th><th>A√ß√µes</th></tr></thead><tbody id="corpoEncomendas"></tbody></table></div>
        </div>
        <div id="tabDiv" class="tab-pane fade">
            <div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead><tr><th>Data</th><th>Cliente</th><th>Tipo</th><th>m¬≥</th><th>Total ‚Ç¨</th><th>Entregue</th><th>Pago</th><th>Saldo</th><th>Obs</th><th>A√ß√µes</th></tr></thead><tbody id="corpoDividas"></tbody></table></div>
        </div>
        <div id="tabVen" class="tab-pane fade">
            <div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead><tr><th>Data</th><th>Cliente</th><th>Tipo</th><th>m¬≥</th><th>Total ‚Ç¨</th><th>Entregue</th><th>Pago</th><th>Saldo</th><th>Obs</th><th>A√ß√µes</th></tr></thead><tbody id="corpoVendas"></tbody></table></div>
        </div>
        <div id="tabLotes" class="tab-pane fade">
            <button class="btn btn-dark btn-sm w-100 mb-3 fw-bold" onclick="window.abrirModalNovoLote()">+ COMPRAR CARGA</button>
            <div id="listaLotes"></div>
        </div>
        <div id="tabFin" class="tab-pane fade">
            <div class="row g-2 mb-3">
                <div class="col-6"><button class="btn btn-danger btn-sm w-100 fw-bold shadow-sm" onclick="window.abrirModalNovaDespesa()">+ REGISTAR GASTO OPERACIONAL</button></div>
                <div class="col-6"><button class="btn btn-info btn-sm w-100 fw-bold text-white shadow-sm" onclick="window.abrirModalNovoDividendo()">üí∞ REGISTAR DIVIDENDO</button></div>
            </div>
            <h6 class="fw-bold mt-4">Lista de Gastos Gerais</h6>
            <table class="table table-sm mb-4"><tbody id="corpoDespesas"></tbody></table>
            <h6 class="fw-bold mt-4 text-info">Dividendos (Retiradas)</h6>
            <table class="table table-sm"><tbody id="corpoDividendos"></tbody></table>
        </div>
        <div id="tabCli" class="tab-pane fade">
            <div class="row g-2 mb-3">
                <div class="col-8"><button class="btn btn-success btn-sm w-100 fw-bold" onclick="window.abrirModalNovoCliente()">+ NOVO CLIENTE</button></div>
                <div class="col-4"><button class="btn btn-outline-dark btn-sm w-100 fw-bold" onclick="window.abrirGerirTipos()">‚öôÔ∏è TIPOS</button></div>
            </div>
            <div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead><tr><th>Nome</th><th>Contacto</th><th>Obs</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="listaClientesTabela"></tbody></table></div>
        </div>
    </div>
</div>

<!-- MODAIS -->
<div class="modal fade" id="modalCli" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Cliente</h6><input type="text" id="cliNome" class="form-control mb-2" placeholder="Nome"><input type="text" id="cliContacto" class="form-control mb-2" placeholder="Contacto"><textarea id="cliObs" class="form-control mb-3" placeholder="Obs fixas..."></textarea><button class="btn btn-success w-100 fw-bold" onclick="window.salvarCliente()">SALVAR</button></div></div>
<div class="modal fade" id="modalEnc" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Encomenda</h6><select id="encCliente" class="form-select mb-2" onchange="window.puxarObsCliente(this.value)"></select><select id="encTipoLenha" class="form-select mb-2"></select><div class="row g-2 mb-2"><div class="col-6"><label class="small">m¬≥:</label><input type="number" id="encMetros" class="form-control" step="0.1"></div><div class="col-6"><label class="small">‚Ç¨/m¬≥:</label><input type="number" id="encPreco" class="form-control" value="75"></div></div><input type="date" id="encDataC" class="form-control mb-2"><textarea id="encObs" class="form-control mb-3" placeholder="Notas..."></textarea><button class="btn btn-primary w-100 fw-bold" onclick="window.salvarEncomenda()">GUARDAR</button></div></div>
<div class="modal fade" id="modalLote" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Carga</h6><input type="text" id="loteNome" class="form-control mb-2" placeholder="Refer√™ncia"><input type="number" id="loteCusto" class="form-control mb-2" placeholder="Custo Compra ‚Ç¨"><input type="date" id="loteData" class="form-control mb-3"><button class="btn btn-dark w-100 fw-bold" onclick="window.salvarLote()">GRAVAR</button></div></div>
<div class="modal fade" id="modalSaidaLote" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Sa√≠da Carga</h6><input type="number" id="saidaLoteM3" class="form-control mb-2" placeholder="m¬≥"><input type="number" id="saidaLoteValor" class="form-control mb-3" placeholder="Valor ‚Ç¨ (balan√ßo)"><button class="btn btn-primary w-100 fw-bold" onclick="window.salvarSaidaLote()">GRAVAR</button></div></div>
<div class="modal fade" id="modalGastoLote" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Gasto Carga</h6><input type="text" id="gastoLoteDesc" class="form-control mb-2" placeholder="Descri√ß√£o"><input type="number" id="gastoLoteValor" class="form-control mb-3" placeholder="Valor ‚Ç¨"><button class="btn btn-danger w-100 fw-bold" onclick="window.salvarGastoLote()">GRAVAR</button></div></div>
<div class="modal fade" id="modalDespesa" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Gasto Geral</h6><input type="text" id="despDesc" class="form-control mb-2" placeholder="Desc (ex: Combust√≠vel, Luz, Aluguer)"><input type="number" id="despValor" class="form-control mb-2" placeholder="‚Ç¨"><input type="date" id="despData" class="form-control mb-3"><button class="btn btn-danger w-100 fw-bold" onclick="window.salvarDespesa()">SALVAR</button></div></div>
<div class="modal fade" id="modalDividendo" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Dividendo</h6><input type="text" id="divDesc" class="form-control mb-2" placeholder="Quem?"><input type="number" id="divValor" class="form-control mb-2" placeholder="‚Ç¨"><input type="date" id="divData" class="form-control mb-3"><button class="btn btn-info text-white w-100 fw-bold" onclick="window.salvarDividendo()">RETIRAR</button></div></div>
<div class="modal fade" id="modalSaldoInicial" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Saldo Caixa</h6><input type="number" id="inputSaldoInicial" class="form-control mb-3"><button class="btn btn-warning w-100 fw-bold" onclick="window.confirmarSaldoInicial()">GRAVAR</button></div></div>
<div class="modal fade" id="modalEntrega" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-4"><h6>Entrega</h6><p>Falta: <b id="faltaM3Texto"></b> m¬≥</p><button class="btn btn-success mb-3 w-100 fw-bold" onclick="window.executarEntregaTotal()">TOTAL</button><div class="input-group"><input type="number" id="qtdParcialM3" class="form-control"><button class="btn btn-warning" onclick="window.executarEntregaParcial()">Ok</button></div></div></div>
<div class="modal fade" id="modalPagamento" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-4"><h6>Pagamento</h6><p class="text-danger">D√≠vida: <b id="faltaDinheiroTexto"></b></p><button class="btn btn-success mb-3 w-100 fw-bold" onclick="window.executarPagamentoTotal()">PAGO TUDO</button><div class="input-group"><input type="number" id="qtdParcialDinheiro" class="form-control"><button class="btn btn-warning" onclick="window.executarPagamentoParcial()">Ok</button></div></div></div>
<div class="modal fade" id="modalGerirTipos" tabindex="-1"><div class="modal-content modal-dialog modal-dialog-centered p-3"><h6>Tipos de Lenha</h6><div class="input-group mb-3"><input type="text" id="novoTipoMadeira" class="form-control"><button class="btn btn-success" onclick="window.adicionarTipoMadeira()">+</button></div><div id="listaTiposContainer" class="list-group"></div><button class="btn btn-secondary w-100 mt-2" data-bs-dismiss="modal">FECHAR</button></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDOsSDIznQ-dpYsLNrfM1JVyHyifJfYOtE",
        authDomain: "lenhapro1.firebaseapp.com",
        databaseURL: "https://lenhapro1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "lenhapro1",
        storageBucket: "lenhapro1.firebasestorage.app",
        messagingSenderId: "357732471130",
        appId: "1:357732471130:web:f4ce43cddb6a996981a363"
    };

    const app = initializeApp(firebaseConfig);
    const dbFirestore = getFirestore(app);
    const docRef = doc(dbFirestore, "producao", "dados_mestre");

    window.db = { clientes: [], encomendas: [], despesas: [], lotes: [], dividendos: [], saldoInicial: 0, tiposLenha: ["Mistura", "Oliveira", "Carvalho", "ELI/CAR", "Eucalipto", "Pinho"] };
    window.cliIdEdicao = null; window.encIdEdicao = null; window.loteIdAtivo = null; window.movIdAtivo = null;
    let chCli = null, chTp = null, chGst = null;

    const toN = (v) => isNaN(parseFloat(v)) ? 0 : parseFloat(v);

    onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) { 
            window.db = docSnap.data(); 
            window.popularAnos();
            if(!document.getElementById('dashFiltroMes').value) {
                document.getElementById('dashFiltroMes').value = String(new Date().getMonth() + 1).padStart(2, '0');
            }
        }
        window.render();
    });

    window.atualizarBD = async function() { await setDoc(docRef, window.db); }
    window.limparResiduosModal = () => { document.querySelectorAll('.modal-backdrop').forEach(b => b.remove()); document.body.classList.remove('modal-open'); document.body.style.overflow = ''; }
    window.fecharModal = (id) => { const m = bootstrap.Modal.getInstance(document.getElementById(id)); if(m) m.hide(); window.limparResiduosModal(); window.atualizarBD(); }
    window.abrirModal = (id) => { window.limparResiduosModal(); new bootstrap.Modal(document.getElementById(id)).show(); }

    window.popularAnos = () => {
        const anos = new Set([new Date().getFullYear().toString()]);
        (window.db.encomendas || []).forEach(e => e.dataEnc && anos.add(e.dataEnc.split('-')[0]));
        const sel = document.getElementById('dashFiltroAno');
        const atual = sel.value || new Date().getFullYear().toString();
        sel.innerHTML = Array.from(anos).sort().reverse().map(a => `<option value="${a}" ${a==atual?'selected':''}>${a}</option>`).join('');
    };

    window.render = function() {
        if(!window.db.clientes) window.db.clientes = []; if(!window.db.encomendas) window.db.encomendas = []; if(!window.db.despesas) window.db.despesas = []; if(!window.db.dividendos) window.db.dividendos = []; if(!window.db.lotes) window.db.lotes = [];
        
        const modo = document.getElementById('dashModoFiltro').value;
        const ano = document.getElementById('dashFiltroAno').value;
        const mes = document.getElementById('dashFiltroMes').value;
        document.getElementById('colMesDash').style.display = (modo === 'ano') ? 'none' : 'block';

        let sRecE=0, sCusL=0, sGstGTotal=0, sDivT=0, m3FGlobal=0, divC=0;
        let dRec=0, dGstTotal=0, dM3=0;
        
        // Dash Breakdown
        let dGstComprasLote = 0, dGstExtrasLote = 0, dGstGeraisPeriodo = 0;
        const custosAgrupados = {};

        const pT = {}; (window.db.tiposLenha||[]).forEach(t => pT[t] = 0);
        const rank={}, tps={};

        // 1. LOTES
        document.getElementById('listaLotes').innerHTML=(window.db.lotes||[]).sort((a,b)=>new Date(b.data)-new Date(a.data)).map(l=>{
            const sV=(l.saidasLenha||[]).reduce((a,c)=>a+toN(c.valor),0);
            const m3V=(l.saidasLenha||[]).reduce((a,c)=>a+toN(c.m3),0);
            const gE=(l.gastosExtras||[]).reduce((a,c)=>a+toN(c.valor),0), cT=toN(l.custoCompra)+gE;
            sCusL += cT;

            if(l.data && l.data.startsWith(ano)) {
                if(modo === 'ano' || l.data.split('-')[1] === mes) {
                    dGstTotal += cT;
                    dGstComprasLote += toN(l.custoCompra);
                    dGstExtrasLote += gE;
                    
                    // Agrupar Custos de Carga
                    if(toN(l.custoCompra) > 0){
                        const k = "COMPRA DE CARGAS";
                        custosAgrupados[k] = (custosAgrupados[k] || 0) + toN(l.custoCompra);
                    }
                    (l.gastosExtras||[]).forEach(gx => {
                        const k = gx.desc.toUpperCase();
                        custosAgrupados[k] = (custosAgrupados[k] || 0) + toN(gx.valor);
                    });
                }
            }
            let movs="";
            (l.saidasLenha||[]).forEach(m=>movs+=`<div class="movimento-item"><span class="text-success">Sa√≠da: ${m.m3}m¬≥ (${toN(m.valor).toFixed(0)}‚Ç¨)</span><div><i class="bi bi-pencil text-primary me-2" onclick="window.abrirEditarSaida('${l.id}','${m.id}')"></i><i class="bi bi-x text-danger" onclick="window.apagarMov('${l.id}','saidasLenha','${m.id}')"></i></div></div>`);
            (l.gastosExtras||[]).forEach(g=>movs+=`<div class="movimento-item"><span class="text-danger">Gasto: ${g.desc} (${toN(g.valor).toFixed(0)}‚Ç¨)</span><div><i class="bi bi-pencil text-primary me-2" onclick="window.abrirEditarGastoLote('${l.id}','${g.id}')"></i><i class="bi bi-x text-danger" onclick="window.apagarMov('${l.id}','gastosExtras','${g.id}')"></i></div></div>`);
            return `<div class="lote-card p-3"><b>${l.nome}</b> (${l.data})<div class="mt-2 bg-light rounded">${movs||'<small class="p-2 d-block text-muted">Sem registos</small>'}</div><div class="mt-2 d-flex justify-content-between align-items-center small"><span>Vendido: ${m3V.toFixed(1)}m¬≥</span><span class="${sV-cT>=0?'text-success':'text-danger'} fw-bold">Bal: ${(sV-cT).toFixed(0)}‚Ç¨</span><div><button class="btn btn-sm btn-primary py-0 me-1" onclick="window.loteIdAtivo='${l.id}'; window.movIdAtivo=null; window.abrirModal('modalSaidaLote')">+ S</button><button class="btn btn-sm btn-danger py-0 me-1" onclick="window.loteIdAtivo='${l.id}'; window.movIdAtivo=null; window.abrirModal('modalGastoLote')">+ G</button><i class="bi bi-trash text-danger" onclick="window.apagar('lotes','${l.id}')"></i></div></div></div>`;
        }).join('');

        // 2. ENCOMENDAS
        let hE="", hD="", hV="";
        (window.db.encomendas||[]).sort((a,b)=>new Date(a.dataEnc)-new Date(b.dataEnc)).forEach(e=>{
            const cli=window.db.clientes.find(c=>c.id==e.clienteId); if(!cli) return;
            const vP=toN(e.valorPago), vT=toN(e.valorTotal), mTot=toN(e.metrosTotal), mEnt=toN(e.metrosEntregues);
            const fM = Math.max(0, mTot - mEnt), sDev = Math.max(0, vT - vP);
            sRecE += vP;
            if(fM > 0) { m3FGlobal += fM; pT[e.tipoLenha] = (pT[e.tipoLenha] || 0) + fM; }
            if(e.dataEnc && e.dataEnc.startsWith(ano)) {
                if(modo === 'ano' || e.dataEnc.split('-')[1] === mes) {
                    dRec += vP; dM3 += mEnt;
                    rank[cli.nome] = (rank[cli.nome] || 0) + mEnt;
                    tps[e.tipoLenha] = (tps[e.tipoLenha] || 0) + mEnt;
                }
            }
            const actions = `<td><i class="bi bi-pencil-square text-primary me-2" onclick="window.abrirEditarEncomenda('${e.id}')"></i><i class="bi bi-trash text-danger" onclick="window.apagar('encomendas','${e.id}')"></i></td>`;
            const obsCell = `<td><div class="obs-container">${e.obs||''}</div></td>`;
            const baseRow = `<td><span class="bg-data">${e.dataEnc}</span><br><b>${cli.nome}</b></td><td><small>${e.tipoLenha}</small></td><td>${mTot}</td><td>${vT.toFixed(0)}‚Ç¨</td>`;
            if(mEnt>=mTot && vP>=vT) hV += `<tr>${baseRow}<td>${mEnt}</td><td>${vP.toFixed(0)}‚Ç¨</td><td class="text-success">Pago</td>${obsCell}${actions}</tr>`;
            else if(mEnt>=mTot && vP<vT) { hD += `<tr>${baseRow}<td>${mEnt}</td><td>${vP.toFixed(0)}‚Ç¨</td><td class="text-danger fw-bold cursor-pointer" onclick="window.abrirPagamento('${e.id}')">${sDev.toFixed(0)}‚Ç¨</td>${obsCell}${actions}</tr>`; divC+=sDev; }
            else { hE += `<tr>${baseRow}<td><span onclick="window.abrirEntrega('${e.id}')" class="status-badge bg-pendente">${mEnt}m¬≥</span></td><td onclick="window.abrirPagamento('${e.id}')" class="${vP>=vT?'text-success':'text-danger fw-bold'}">${vP.toFixed(0)}‚Ç¨</td>${obsCell}${actions}</tr>`; }
        });
        document.getElementById('corpoEncomendas').innerHTML=hE; document.getElementById('corpoDividas').innerHTML=hD; document.getElementById('corpoVendas').innerHTML=hV.split('<tr>').reverse().join('<tr>');
        
        // 3. DESPESAS GERAIS (OP)
        sGstGTotal = (window.db.despesas||[]).reduce((a,c)=>{ 
            if(c.data && c.data.startsWith(ano)) {
                if(modo === 'ano' || c.data.split('-')[1] === mes) {
                    const val = toN(c.valor);
                    dGstTotal += val;
                    dGstGeraisPeriodo += val;
                    const k = c.desc.toUpperCase();
                    custosAgrupados[k] = (custosAgrupados[k] || 0) + val;
                }
            }
            return a+toN(c.valor); 
        }, 0);

        // 4. TABELA AGRUPADA NO DASH
        let htmlGst = "";
        const sortedGst = Object.entries(custosAgrupados).sort((a,b) => b[1]-a[1]);
        sortedGst.forEach(([desc, total]) => {
            const perc = dGstTotal > 0 ? ((total/dGstTotal)*100).toFixed(0) : 0;
            htmlGst += `<tr><td>${desc}</td><td class="text-end fw-bold">${total.toFixed(2)}‚Ç¨</td><td class="text-end text-muted">${perc}%</td></tr>`;
        });
        document.getElementById('tabelaCustosAgrupados').innerHTML = htmlGst || '<tr><td colspan="3" class="text-center">Sem registos</td></tr>';
        document.getElementById('totalCustosDash').innerText = dGstTotal.toFixed(2) + "‚Ç¨";

        // 5. KPIs FINANCEIROS
        const margem = dRec > 0 ? (((dRec - dGstTotal) / dRec) * 100) : 0;
        document.getElementById('dashMargemMes').innerText = margem.toFixed(0) + "%";
        document.getElementById('dashReceitaMes').innerText = dRec.toFixed(0) + "‚Ç¨";
        document.getElementById('dashGastoMes').innerText = dGstTotal.toFixed(0) + "‚Ç¨";
        document.getElementById('dashMetrosMes').innerText = dM3.toFixed(1);

        // 6. RESUMO GLOBAL
        sDivT=(window.db.dividendos||[]).reduce((a,c)=>a+toN(c.valor), 0);
        const lucT = sRecE - (sCusL + sGstGTotal);
        const caixaFinal = (toN(window.db.saldoInicial) + lucT) - sDivT;
        document.getElementById('resumoCaixaTotal').innerText=caixaFinal.toFixed(0)+"‚Ç¨";
        document.getElementById('resumoPendentesGlobal').innerText=m3FGlobal.toFixed(1)+" m¬≥";
        document.getElementById('resumoDividaEntregue').innerText=divC.toFixed(0)+"‚Ç¨";
        document.getElementById('resumoLucro').innerText=lucT.toFixed(0)+"‚Ç¨";
        
        // PENDENTES POR TIPO
        let pL=""; for(let t in pT) if(pT[t]>0) pL+=`<div class="pendente-item"><span>${t}:</span> <b>${pT[t].toFixed(1)} m¬≥</b></div>`;
        document.getElementById('listaPendentesPorTipo').innerHTML = pL || '<small class="text-muted">Nada pendente.</small>';

        // FINAN√áAS TAB
        document.getElementById('corpoDespesas').innerHTML=(window.db.despesas||[]).sort((a,b)=>new Date(b.data)-new Date(a.data)).map(d=>`<tr><td>${d.data}</td><td>${d.desc}</td><td>${toN(d.valor).toFixed(2)}‚Ç¨</td><td class="text-end"><i class="bi bi-trash text-danger" onclick="window.apagar('despesas', '${d.id}')"></i></td></tr>`).join('');
        document.getElementById('corpoDividendos').innerHTML=(window.db.dividendos||[]).sort((a,b)=>new Date(b.data)-new Date(a.data)).map(d=>`<tr><td>${d.data}</td><td>${d.desc}</td><td>${toN(d.valor).toFixed(2)}‚Ç¨</td><td class="text-end"><i class="bi bi-trash text-danger" onclick="window.apagar('dividendos', '${d.id}')"></i></td></tr>`).join('');
        document.getElementById('listaClientesTabela').innerHTML=(window.db.clientes||[]).map(c=>`<tr><td><b>${c.nome}</b></td><td>${c.contacto||''}</td><td><div class="obs-container">${c.obs||''}</div></td><td class="text-end"><i class="bi bi-pencil-square text-primary me-2" onclick="window.abrirEditarCliente('${c.id}')"></i><i class="bi bi-trash text-danger" onclick="window.apagar('clientes','${c.id}')"></i></td></tr>`).join('');

        window.updateCharts(rank, tps, [dGstComprasLote, dGstExtrasLote, dGstGeraisPeriodo]);
    };

    window.updateCharts=(rank, tps, gBreakdown)=>{
        if(chCli) chCli.destroy(); if(chTp) chTp.destroy(); if(chGst) chGst.destroy();
        const cfg = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
        
        chCli = new Chart(document.getElementById('chartClientes'), { type:'bar', data: { labels: Object.keys(rank), datasets: [{ data: Object.values(rank), backgroundColor: '#1a252f' }] }, options: cfg });
        chTp = new Chart(document.getElementById('chartTipos'), { type: 'doughnut', data: { labels: Object.keys(tps), datasets: [{ data: Object.values(tps), backgroundColor: ['#e67e22', '#27ae60', '#3498db', '#f39c12', '#c0392b', '#7f8c8d'] }] }, options: { ...cfg, plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 10, font: { size: 9 } } } } } });
        chGst = new Chart(document.getElementById('chartGastoDist'), { type: 'pie', data: { labels: ['Cargas', 'Extras', 'Geral'], datasets: [{ data: gBreakdown, backgroundColor: ['#c0392b', '#e67e22', '#7f8c8d'] }] }, options: { ...cfg, plugins: { legend: { display: true, position: 'right', labels: { boxWidth: 10, font: { size: 9 } } } } } });
    };

    // FUN√á√ïES RESTANTES (Salvar, Abrir, Apagar)
    window.salvarSaidaLote = () => { const l = window.db.lotes.find(x => x.id == window.loteIdAtivo); const d = { m3: toN(document.getElementById('saidaLoteM3').value), valor: toN(document.getElementById('saidaLoteValor').value) }; if(window.movIdAtivo){ const i = l.saidasLenha.findIndex(x => x.id == window.movIdAtivo); l.saidasLenha[i] = { ...l.saidasLenha[i], ...d }; } else { l.saidasLenha.push({ id: Date.now().toString(), ...d }); } window.fecharModal('modalSaidaLote'); };
    window.salvarGastoLote = () => { const l = window.db.lotes.find(x => x.id == window.loteIdAtivo); const d = { desc: document.getElementById('gastoLoteDesc').value, valor: toN(document.getElementById('gastoLoteValor').value) }; if(window.movIdAtivo){ const i = l.gastosExtras.findIndex(x => x.id == window.movIdAtivo); l.gastosExtras[i] = { ...l.gastosExtras[i], ...d }; } else { l.gastosExtras.push({ id: Date.now().toString(), ...d }); } window.fecharModal('modalGastoLote'); };
    window.abrirEditarSaida = (lId, mId) => { window.loteIdAtivo = lId; window.movIdAtivo = mId; const l = window.db.lotes.find(x => x.id == lId); const m = l.saidasLenha.find(x => x.id == mId); document.getElementById('saidaLoteM3').value = m.m3; document.getElementById('saidaLoteValor').value = m.valor; window.abrirModal('modalSaidaLote'); }
    window.abrirEditarGastoLote = (lId, mId) => { window.loteIdAtivo = lId; window.movIdAtivo = mId; const l = window.db.lotes.find(x => x.id == lId); const g = l.gastosExtras.find(x => x.id == mId); document.getElementById('gastoLoteDesc').value = g.desc; document.getElementById('gastoLoteValor').value = g.valor; window.abrirModal('modalGastoLote'); }
    window.abrirGerirTipos = () => { document.getElementById('listaTiposContainer').innerHTML = (window.db.tiposLenha||[]).map(t => `<div class="list-group-item d-flex justify-content-between py-1"><span>${t}</span><i class="bi bi-trash text-danger" onclick="window.removerTipoMadeira('${t}')"></i></div>`).join(''); window.abrirModal('modalGerirTipos'); };
    window.adicionarTipoMadeira = () => { const i = document.getElementById('novoTipoMadeira'); if(i.value) { window.db.tiposLenha.push(i.value); i.value=""; window.fecharModal('modalGerirTipos'); } };
    window.removerTipoMadeira = (t) => { if(confirm("Apagar?")) { window.db.tiposLenha = window.db.tiposLenha.filter(x=>x!==t); window.atualizarBD(); } };
    window.abrirModalNovoCliente = () => { window.cliIdEdicao = null; document.getElementById('cliNome').value=""; document.getElementById('cliContacto').value=""; document.getElementById('cliObs').value=""; window.abrirModal('modalCli'); };
    window.abrirEditarCliente = (id) => { window.cliIdEdicao = id; const c = window.db.clientes.find(x=>x.id==id); document.getElementById('cliNome').value=c.nome; document.getElementById('cliContacto').value=c.contacto||""; document.getElementById('cliObs').value=c.obs||""; window.abrirModal('modalCli'); };
    window.salvarCliente = () => { const n = document.getElementById('cliNome').value; if(!n) return; const d = { nome:n, contacto:document.getElementById('cliContacto').value, obs:document.getElementById('cliObs').value }; if(window.cliIdEdicao){ const i=window.db.clientes.findIndex(x=>x.id==window.cliIdEdicao); window.db.clientes[i]={id:window.cliIdEdicao,...d}; } else { window.db.clientes.push({id:Date.now().toString(),...d}); } window.fecharModal('modalCli'); };
    window.abrirModalEncomenda = () => { window.encIdEdicao=null; document.getElementById('encCliente').innerHTML=window.db.clientes.map(c=>`<option value="${c.id}">${c.nome}</option>`).join(''); document.getElementById('encTipoLenha').innerHTML=window.db.tiposLenha.map(t=>`<option value="${t}">${t}</option>`).join(''); document.getElementById('encMetros').value=""; document.getElementById('encDataC').value=new Date().toISOString().split('T')[0]; window.abrirModal('modalEnc'); };
    window.abrirEditarEncomenda = (id) => { window.encIdEdicao=id; const e=window.db.encomendas.find(x=>x.id==id); document.getElementById('encCliente').innerHTML=window.db.clientes.map(c=>`<option value="${c.id}" ${c.id==e.clienteId?'selected':''}>${c.nome}</option>`).join(''); document.getElementById('encTipoLenha').innerHTML=window.db.tiposLenha.map(t=>`<option value="${t}" ${t==e.tipoLenha?'selected':''}>${t}</option>`).join(''); document.getElementById('encMetros').value=e.metrosTotal; document.getElementById('encPreco').value=e.precoM3; document.getElementById('encDataC').value=e.dataEnc; document.getElementById('encObs').value=e.obs||""; window.abrirModal('modalEnc'); };
    window.salvarEncomenda = () => { const m=toN(document.getElementById('encMetros').value), p=toN(document.getElementById('encPreco').value); const d={ clienteId:document.getElementById('encCliente').value, tipoLenha:document.getElementById('encTipoLenha').value, dataEnc:document.getElementById('encDataC').value, metrosTotal:m, precoM3:p, valorTotal:m*p, obs:document.getElementById('encObs').value }; if(window.encIdEdicao){ const i=window.db.encomendas.findIndex(x=>x.id==window.encIdEdicao); window.db.encomendas[i]={...window.db.encomendas[i],...d}; } else { window.db.encomendas.push({id:Date.now().toString(), metrosEntregues:0, valorPago:0,...d}); } window.fecharModal('modalEnc'); };
    window.abrirModalNovoLote = () => { window.loteIdAtivo=null; document.getElementById('loteNome').value=""; document.getElementById('loteCusto').value=""; document.getElementById('loteData').value=new Date().toISOString().split('T')[0]; window.abrirModal('modalLote'); };
    window.salvarLote = () => { const d = { nome: document.getElementById('loteNome').value, custoCompra: toN(document.getElementById('loteCusto').value), data: document.getElementById('loteData').value }; if(window.loteIdAtivo){ const i = window.db.lotes.findIndex(x=>x.id==window.loteIdAtivo); window.db.lotes[i] = {...window.db.lotes[i], ...d}; } else { window.db.lotes.push({id:Date.now().toString(), ...d, gastosExtras:[], saidasLenha:[]}); } window.fecharModal('modalLote'); };
    window.abrirModalNovaDespesa = () => { document.getElementById('despDesc').value=""; document.getElementById('despValor').value=""; document.getElementById('despData').value=new Date().toISOString().split('T')[0]; window.abrirModal('modalDespesa'); };
    window.salvarDespesa = () => { window.db.despesas.push({ id:Date.now().toString(), desc: document.getElementById('despDesc').value.toUpperCase(), valor: toN(document.getElementById('despValor').value), data: document.getElementById('despData').value }); window.fecharModal('modalDespesa'); };
    window.abrirModalNovoDividendo = () => { document.getElementById('divDesc').value=""; document.getElementById('divValor').value=""; document.getElementById('divData').value=new Date().toISOString().split('T')[0]; window.abrirModal('modalDividendo'); };
    window.salvarDividendo = () => { window.db.dividendos.push({id:Date.now().toString(), desc:document.getElementById('divDesc').value, valor:toN(document.getElementById('divValor').value), data:document.getElementById('divData').value}); window.fecharModal('modalDividendo'); };
    window.confirmarSaldoInicial=()=>{ window.db.saldoInicial=toN(document.getElementById('inputSaldoInicial').value); window.fecharModal('modalSaldoInicial'); };
    window.puxarObsCliente=(id)=>{ const c=window.db.clientes.find(x=>x.id==id); if(c && !window.encIdEdicao) document.getElementById('encObs').value=c.obs||""; };
    window.abrirEntrega=(id)=>{ window.idAtivo=id; const e=window.db.encomendas.find(x=>x.id==id); document.getElementById('faltaM3Texto').innerText=(toN(e.metrosTotal)-toN(e.metrosEntregues)).toFixed(1); window.abrirModal('modalEntrega'); };
    window.abrirPagamento=(id)=>{ window.idAtivo=id; const e=window.db.encomendas.find(x=>x.id==id); document.getElementById('faltaDinheiroTexto').innerText=(toN(e.valorTotal)-toN(e.valorPago)).toFixed(2)+"‚Ç¨"; window.abrirModal('modalPagamento'); };
    window.executarEntregaTotal=()=>{ const e=window.db.encomendas.find(x=>x.id==window.idAtivo); if(e) e.metrosEntregues=e.metrosTotal; window.fecharModal('modalEntrega'); };
    window.executarEntregaParcial=()=>{ const e=window.db.encomendas.find(x=>x.id==window.idAtivo); const v=toN(document.getElementById('qtdParcialM3').value); if(e && v>0) e.metrosEntregues+=v; window.fecharModal('modalEntrega'); };
    window.executarPagamentoTotal=()=>{ const e=window.db.encomendas.find(x=>x.id==window.idAtivo); if(e) e.valorPago=e.valorTotal; window.fecharModal('modalPagamento'); };
    window.executarPagamentoParcial=()=>{ const e=window.db.encomendas.find(x=>x.id==window.idAtivo); const v=toN(document.getElementById('qtdParcialDinheiro').value); if(e && v>0) e.valorPago+=v; window.fecharModal('modalPagamento'); };
    window.apagar=(t,id)=>{ if(confirm("Apagar?")) { window.db[t]=window.db[t].filter(x=>x.id!=id); window.atualizarBD(); } };
    window.apagarMov=(lId,t,mId)=>{ if(confirm("Apagar?")) { const l=window.db.lotes.find(x=>x.id==lId); l[t]=l[t].filter(x=>x.id!=mId); window.atualizarBD(); } };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
